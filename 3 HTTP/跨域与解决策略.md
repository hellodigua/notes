# 跨域与解决策略

## QA

1. 为什么存在跨域这个问题？

   因为浏览器中存在**同源策略**

2. 同源策略是什么？为什么要有同源策略？

   如果两个页面的**协议**，**端口**（如果有指定）和**域名**都相同，则两个页面具有相同的源。浏览器对 JavaScript 实施的安全限制，限制了不同源之间的交互，叫同源策略。这是为了预防某些恶意行为。

3. 跨域有哪些常用方法？

   - jsonp 跨域
   - CORS

特别注意两点：

- 如果是协议和端口造成的跨域问题“前台”是无能为力的，
- 在跨域问题上，域仅仅是通过“URL 的首部”来识别而不会去尝试判断相同的 ip 地址对应着两个域或两个域是否在同一个 ip 上。
  “URL 的首部”指 window.location.protocol + window.location.host，也可以理解为“Domains, protocols and ports must match”。

## 解决策略

### jsonp

`JSONP`: JSON with Padding or JSON-P[1]。他允许绕过同源策略共享数据。但由于固有的不安全性，`JSONP` 正在被 `CORS` 所取代。

#### why

**存在安全隐患，建议使用 `CORS` 替代。**

- 不可信的第三方代码

  使用远程网站的 script 标签会让远程网站得以注入**任何**的内容至网站里。如果远程的网站有 JavaScript 注入漏洞，原来的网站也会受到影响。

- 回调名称操作和反射文件下载攻击

  未经把控的回调名称可以被用来传递恶意数据给客户端，绕过 application/json 类型相关的限制，比如 2014 年反射文件下载（RFD）攻击所示。

- 跨网站请求伪造 CSRF

  由于 HTML `<script>` 标签在网络浏览器实现中不遵守同源策略，因此恶意页面可以请求并获取属于其他站点的 JSON 数据。这将允许在恶意页面的上下文中处理这些数据，如果用户当前登录到其他站点，则可能泄漏了密码或其他敏感数据。

### CORS

出于安全原因，浏览器限制了从 script 中发起的 cross-origin HTTP 请求。例如 XMLHttpRequest 和 Fetch 等 APIs 遵循同源策略。因此，除非使用 CORS ，否则使用这些 APIs 的应用只能从加载该应用的相同域中，请求 HTTP 资源。

`CORS` [Cross-Origin Resource Sharing 跨源资源共享]是一种机制，它的工作原理是，添加额外的 HTTP Headers 来让服务器描述允许使用浏览器读取某一资源的一组 origin 。该机制要求浏览器对可能给服务器数据造成 side-effects 的 HTTP request 进行预检 (preflight) ：使用 HTTP OPTIONS 请求方法从服务器请求回 supported methods 后，在服务器 "approval" 的前提下，使用实际的 HTTP method 来发送 request。

需要用到 `CORS` 的比如有：

1. 跨域使用 XMLHttpRequest / Fetch APIs
2. Web 字体（CSS @font-face 中的跨域字体）
3. 使用 drawImage 绘制到 canvas 的 images / video frames
4. WebGL textures ...

[MDN - HTTP 访问控制（CORS）](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)
[我知道的跨域与安全](https://juejin.im/post/5a6320d56fb9a01cb64ee191)
